
<h1 class="room-title"><%= title || 'GIF ì±„íŒ…ë°©' %></h1>
<div class="room-actions">
  <a href="/" id="exit-btn" class="btn">ë°© ë‚˜ê°€ê¸°</a>
</div>

<section class="chat-panel">
  <div id="chat-list" class="chat-list">
    <% chats.forEach(function(chat){ 
         const type = chat.chatType || 'local';
         const from = chat.user || chat.from;
         const to   = chat.to || '';
         const isSystem = chat.user === 'system';
         const isMine = String(from) === String(user);
         const isWhisper = type === 'whisper';
         const isBroadcast = type === 'broadcast';
         const typeClass = isWhisper ? 'type-whisper' : (isBroadcast ? 'type-broadcast' : 'type-local');

         const sock = chat.socketId || '';
         const shortSock = sock ? `${sock.substring(0,4)}...` : '';
    %>
      <div 
        class="message <%= isSystem ? 'system' : (isMine ? 'mine' : 'other') %> <%= typeClass %>"
        <% if (isWhisper) { %>
          data-reply-socket-id="<%= sock %>" 
          data-reply-user="<%= from %>"
        <% } %>
      >
        <% /* ë°©ì†¡ì¼ ë•Œë„ ì•„ë°”íƒ€ ìˆ¨ê¹€: not isSystem && not isWhisper && not isBroadcast */ %>
        <% if (!isSystem && !isWhisper && !isBroadcast) { %>
          <div class="avatar" style="--avatar-color:<%= chat.color || '#888' %>;">
            <%= (String(from||'U').charAt(0) || 'U').toUpperCase() %>
          </div>
        <% } %>

        <div class="bubble <%= isBroadcast ? 'broadcast-bubble' : '' %>">
          <% if (isWhisper) { %>
            <!-- ê·“ì†ë§ -->
            <div class="meta">[ê·“ì†ë§] <%= from || sock %> â†’ <%= isMine ? (to || 'ìƒëŒ€') : 'ë‚˜' %></div>
            <div class="text"><%= chat.chat %></div>
            <div class="actions">
              <button type="button" class="btn btn-light whisper-reply"
                      data-socket-id="<%= sock %>"
                      data-user="<%= from %>">ë‹µì¥</button>
            </div>

          <% } else if (isBroadcast) { %>
            <!-- ë°©ì†¡: ì „ì²´ í­ + ì™¸ì¹˜ê¸° ì•„ì´ì½˜ -->
            <div class="meta">
              <span class="shout-icon" aria-hidden="true">ğŸ“¢</span>
              <span class="badge type-broadcast">ë°©ì†¡</span>
              <span class="route"><%= from || 'Guest' %> â†’ ëª¨ë‘</span>
              <span class="sock socket-id-display" data-socket-id="<%= sock %>"><%= shortSock ? '(' + shortSock + ')' : '' %></span>
            </div>
            <% if (chat.gif) { %>
              <img class="bubble-gif" src="/gif/<%= chat.gif %>" alt="gif">
            <% } else { %>
              <div class="text"><%= chat.chat %></div>
            <% } %>

          <% } else { %>
            <!-- ì¼ë°˜(local) -->
            <% if (!isSystem) { %>
              <div class="meta">
                <span class="name socket-id-display" data-socket-id="<%= sock %>">
                  <%= from || 'Guest' %> <%= shortSock ? '(' + shortSock + ')' : '' %>
                </span>
                <span class="badge type-local">ì¼ë°˜</span>
              </div>
            <% } %>
            <% if (chat.gif) { %>
              <img class="bubble-gif" src="/gif/<%= chat.gif %>" alt="gif">
            <% } else { %>
              <div class="text"><%= chat.chat %></div>
            <% } %>
          <% } %>
        </div>
      </div>
    <% }) %>
  </div>
</section>


  <!-- ì…ë ¥ì˜ì—­(ì‘ì€ í™”ë©´ì—ì„œëŠ” í•­ìƒ í•˜ë‹¨ ê³ ì •) -->
  <div class="composer">
    <form action="/chat" id="chat-form" method="post" enctype="multipart/form-data" class="composer-row">
      <label for="gif" class="btn btn-light">GIF</label>
      <input type="file" id="gif" name="gif" accept="image/gif" hidden>
      <input type="text" id="chat" name="chat" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦">
      <button type="submit" class="btn btn-primary">ì „ì†¡</button>
    </form>

    <form action="/broadcastchat" id="broadcastchat-form" method="post" class="composer-row">
      <label class="composer-label">ì™¸ì¹˜ê¸°</label>
      <input type="text" id="broadcastchat-input" name="chat" placeholder="ëª¨ë‘ì—ê²Œ ì™¸ì¹˜ê¸°">
      <button type="submit" class="btn">ì „ì†¡</button>
    </form>

    <!-- ê·“ì†ë§ -->
    <form action="/whisperchat" id="whisperchat-form" method="post" class="composer-row whisper" style="display:none;">
      <input type="hidden" id="whisper-target-socketid" name="targetSocketId">
      <input type="hidden" id="whisper-source-user" name="sourceSocketUser" value="<%=user.nick%>">
      <input type="hidden" id="whisper-target-user" name="targetSocketUser">
      <span class="whisper-target">ëŒ€ìƒ: <strong id="whisper-target-display"></strong></span>
      <input type="text" id="whisper-chat-input" name="chat" placeholder="ê·“ì†ë§ ë‚´ìš©">
      <button type="submit" class="btn btn-accent">ê·“ì†ë§ ì „ì†¡</button>
      <button type="button" id="whisper-cancel-btn" class="btn btn-light">ì·¨ì†Œ</button>
    </form>
  </div>
</section>

<!-- ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš© (socket, axios ë“±) -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io('/chat', { path: '/socket.io', withCredentials: true });
  const myUser = '<%= user %>';
  const chatList = document.querySelector('#chat-list');
  const whisperForm = document.querySelector('#whisperchat-form');
  const whisperCancelBtn = document.querySelector('#whisper-cancel-btn');
  const whisperTargetDisplay = document.querySelector('#whisper-target-display');
  const whisperTargetSocketId = document.querySelector('#whisper-target-socketid');
  const whisperChatInput = document.querySelector('#whisper-chat-input');

  socket.on('connect', () => {
    const roomId = new URL(location).pathname.split('/').at(-1);
    socket.emit('join', roomId);
  });

  // ì‹œìŠ¤í…œ ë©”ì‹œì§€
  ['join','exit'].forEach(evt => {
    socket.on(evt, data => {
      const div = document.createElement('div');
      div.className = 'message system';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = data.chat;
      div.appendChild(bubble);
      chatList.appendChild(div);
      chatList.scrollTop = chatList.scrollHeight;
    });
  });


  // ê·“ì†ë§ ìˆ˜ì‹ 
socket.on('whisper', data => {
  // data: { fromSocketId, fromUser, chat }
  const div = document.createElement('div');
  // ê¸°ì¡´ í´ë˜ìŠ¤ + íƒ€ì… êµ¬ë¶„ í´ë˜ìŠ¤ ì¶”ê°€
  div.className = 'message system whisper-in type-whisper';

  // ë‹µì¥ì— ì“°ê¸° ìœ„í•´ ë°ì´í„° ë³´ê´€
  div.dataset.replySocketId = data.fromSocketId || '';
  div.dataset.replyUser = data.fromUser || '';

  const bubble = document.createElement('div');
  bubble.className = 'bubble whisper-bubble'; // ë²„ë¸”ì—ë„ íƒ€ì… í´ë˜ìŠ¤ ì¶”ê°€

  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.innerHTML = `[ê·“ì†ë§] ${data.fromUser || data.fromSocketId} â†’ ë‚˜`;
  bubble.appendChild(meta);

  const text = document.createElement('div');
  text.className = 'text';
  text.textContent = data.chat || '';
  bubble.appendChild(text);

  // ë‹µì¥ ë²„íŠ¼
  const actions = document.createElement('div');
  actions.className = 'actions';
  const replyBtn = document.createElement('button');
  replyBtn.type = 'button';
  replyBtn.className = 'btn btn-light whisper-reply';
  replyBtn.dataset.socketId = data.fromSocketId || '';
  replyBtn.dataset.user = data.fromUser || '';
  replyBtn.textContent = 'ë‹µì¥';
  actions.appendChild(replyBtn);
  bubble.appendChild(actions);

  div.appendChild(bubble);
  chatList.appendChild(div);

  // ë¶€ë“œëŸ½ê²Œ ë§¨ ì•„ë˜ë¡œ
  div.scrollIntoView({ block: 'end' });
});


  // ì¼ë°˜/ì‹¤ì‹œê°„ ì±„íŒ…
  socket.on('chat', function (data) {
    const doc = data.chat || data;
    const isMine = data.socketId && socket.id === data.socketId;

    const item = document.createElement('div');
    item.className = 'message ' + (isMine ? 'mine' : 'other');

    if (!isMine) {
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.style.backgroundColor = (doc.color || '#888');
      avatar.textContent = String(doc.user || 'U').charAt(0).toUpperCase();
      item.appendChild(avatar);
    }

    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    const meta = document.createElement('div');
    meta.className = 'meta';
    const name = document.createElement('span');
    name.className = 'name socket-id-display';
    name.dataset.socketId = data.socketId || '';
    name.textContent = `${doc.user || 'Guest'} ${data.socketId ? '(' + data.socketId.substring(0,4) + '...)' : ''}`;
    meta.appendChild(name);
    bubble.appendChild(meta);

    if (doc.gif) {
      const img = document.createElement('img');
      img.className = 'bubble-gif';
      img.src = '/gif/' + doc.gif;
      bubble.appendChild(img);
    } else if (doc.chat) {
      const text = document.createElement('div');
      text.className = 'text';
      text.textContent = doc.chat;
      bubble.appendChild(text);
    }

    item.appendChild(bubble);
    chatList.appendChild(item);
    chatList.scrollTop = chatList.scrollHeight;
  });

  // // ë°©ì†¡ ì±„íŒ…
  // socket.on('broadcastchat', data => {
  //   const isMine = data.user === '<%= user %>';
  //   const item = document.createElement('div');
  //   item.className = 'message ' + (isMine ? 'mine' : 'other');
  //   const bubble = document.createElement('div');
  //   bubble.className = 'bubble';
  //   bubble.innerHTML = `<div class="meta"><span class="name">${data.user}</span></div>`;
  //   if (data.chat) bubble.innerHTML += `<div class="text">${data.chat}</div>`;
  //   if (data.gif)  bubble.innerHTML += `<img class="bubble-gif" src="/gif/${data.gif}">`;
  //   item.appendChild(bubble);
  //   chatList.appendChild(item);
  //   chatList.scrollTop = chatList.scrollHeight;
  // });

  // ë°©ì†¡ ì±„íŒ…
socket.on('broadcastchat', data => {
  // data: { user, chat, gif, socketId? }
  const item = document.createElement('div');
  item.className = 'message system type-broadcast';   // ì „ì²´ í­ + ì¤‘ì•™ ì •ë ¬

  const bubble = document.createElement('div');
  bubble.className = 'bubble broadcast-bubble';       // ë°©ì†¡ ì „ìš© ë²„ë¸” ìŠ¤íƒ€ì¼

  // ë©”íƒ€: ğŸ“¢ ì•„ì´ì½˜ + ë°©ì†¡ ë°°ì§€ + ë¼ìš°íŒ… + (ì„ íƒ) ì†Œì¼“ID
  const meta = document.createElement('div');
  meta.className = 'meta';

  const icon = document.createElement('span');
  icon.className = 'shout-icon';
  icon.textContent = 'ğŸ“¢';

  const badge = document.createElement('span');
  badge.className = 'badge type-broadcast';
  badge.textContent = 'ë°©ì†¡';

  const route = document.createElement('span');
  route.className = 'route';
  route.textContent = `${data.user || 'Guest'} â†’ ëª¨ë‘`;

  meta.append(icon, badge, route);

  // (ì„ íƒ) ì§§ì€ ì†Œì¼“ID í‘œì‹œ
  if (data.socketId) {
    const shortSock = `${String(data.socketId).substring(0,4)}...`;
    const sock = document.createElement('span');
    sock.className = 'sock socket-id-display';
    sock.dataset.socketId = data.socketId;
    sock.textContent = ` (${shortSock})`;
    meta.appendChild(sock);
  }

  bubble.appendChild(meta);

  // ë³¸ë¬¸/ì´ë¯¸ì§€
  if (data.chat) {
    const text = document.createElement('div');
    text.className = 'text';
    text.textContent = data.chat;     // XSS ì•ˆì „
    bubble.appendChild(text);
  }
  if (data.gif) {
    const img = document.createElement('img');
    img.className = 'bubble-gif';
    img.src = `/gif/${data.gif}`;
    img.alt = 'gif';
    bubble.appendChild(img);
  }

  item.appendChild(bubble);
  chatList.appendChild(item);
  item.scrollIntoView({ block: 'end' });
});


  const whisperTargetUserInput = document.querySelector('#whisper-target-user');
  
  function openWhisperForm(targetId, fromUser) {
    if (!targetId) return;
    if (targetId === socket.id) {
      alert('ìê¸° ìì‹ ì—ê²ŒëŠ” ê·“ì†ë§ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    const shortSock = targetId.substring(0, 4) + '...';
    whisperTargetSocketId.value = targetId;
    whisperTargetDisplay.textContent = fromUser ? `${fromUser} (${shortSock})` : shortSock;
    whisperForm.style.display = 'grid';

    whisperTargetUserInput.value = fromUser || '';

    whisperChatInput.focus();
  }

  chatList.addEventListener('click', (e) => {
    // 1) "ë‹µì¥" ë²„íŠ¼ (ê°€ì¥ ìš°ì„ )
    const replyBtn = e.target.closest('.whisper-reply');
    if (replyBtn) {
      const targetId = replyBtn.dataset.socketId || '';
      const fromUser = replyBtn.dataset.user || '';
      openWhisperForm(targetId, fromUser);
      return; // ë” ì´ìƒ ì „íŒŒ ì²˜ë¦¬ X
    }

    // 2) ì¼ë°˜ ë©”ì‹œì§€ì˜ "ì´ë¦„(ì†Œì¼“ID)" í´ë¦­
    const socketSpan = e.target.closest('.socket-id-display');
    if (socketSpan) {
      const targetId = socketSpan.dataset.socketId || '';
      const fromUser = socketSpan.textContent?.trim().split(' (')[0] || '';
      if (!targetId) {
        alert('ìœ íš¨í•œ ì†Œì¼“ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
    
      const whisperForm = document.querySelector('#whisperchat-form');
      const whisperTargetUser = whisperForm.querySelector('#whisper-target-user');
      whisperTargetUser.value = fromUser || '';  // ì˜ˆ: ê·“ì†ë§ ëŒ€ìƒì˜ ë‹‰ë„¤ì„

      openWhisperForm(targetId, fromUser);
      return;
    }

    // 3) ìˆ˜ì‹ í•œ ê·“ì†ë§ì˜ ë²„ë¸” í´ë¦­
    const whisperMsg = e.target.closest('.message.whisper-in');
    if (whisperMsg && whisperMsg.querySelector('.bubble')?.contains(e.target)) {
      const targetId = whisperMsg.dataset.replySocketId || '';
      const fromUser = whisperMsg.dataset.replyUser || '';
      openWhisperForm(targetId, fromUser);
      return;
    }
  });

  whisperCancelBtn.addEventListener('click', () => {
    whisperForm.style.display = 'none';
    whisperTargetSocketId.value = '';
    whisperChatInput.value = '';
  });

  // ì „ì†¡ í•¸ë“¤ëŸ¬
  document.querySelector('#chat-form').addEventListener('submit', function (e) {
    e.preventDefault();
    if (this.chat.value) {
      axios.post('/room/<%= room._id %>/chat', { chat: this.chat.value })
        .then(() => { this.chat.value=''; })
        .catch(console.error);
    }
  });

  document.querySelector('#broadcastchat-form').addEventListener('submit', function (e) {
    e.preventDefault();
    if (this.chat.value) {
      axios.post('/room/<%= room._id %>/broadcastchat', { chat: this.chat.value })
        .then(() => { this.chat.value=''; })
        .catch(console.error);
    }
  });

  document.querySelector('#gif').addEventListener('change', e => {
    const file = e.target.files?.[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('gif', file);
    axios.post('/room/<%= room._id %>/gif', formData)
      .then(() => { e.target.value = null; })
      .catch(console.error);
  });


document.querySelector('#whisperchat-form').addEventListener('submit', function (e) {
  e.preventDefault();

  const targetSocketId = this.targetSocketId.value?.trim();
  const chat = this.chat.value?.trim();
  const targetSocketUser = this.targetSocketUser.value?.trim();
  const sourceSocketUser = this.sourceSocketUser.value?.trim();

  if (targetSocketId && chat) {
    axios.post('/room/<%= room._id %>/whisperchat', {
      targetSocketId,
      targetSocketUser,
      sourceSocketUser,
      chat,
    })
    .then(() => {
      // ë‚´ í™”ë©´ì—ë„ "ë‚´ê°€ ë³´ë‚¸ ê·“ì†ë§" í‘œì‹œ
      const div = document.createElement('div');
      div.className = 'message system whisper-out type-whisper'; // í†µì¼ëœ íƒ€ì… í´ë˜ìŠ¤ ì¶”ê°€

      // ë‹µì¥ìš© ë°ì´í„° ë³´ê´€
      div.dataset.replySocketId = targetSocketId;
      div.dataset.replyUser = targetSocketUser;

      const bubble = document.createElement('div');
      bubble.className = 'bubble whisper-bubble'; // ë²„ë¸” íƒ€ì… í´ë˜ìŠ¤

      // meta: ë³´ë‚¸ ìª½ì´ë¯€ë¡œ ë‚˜ â†’ ìƒëŒ€
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `[ê·“ì†ë§] ë‚˜ â†’ ${targetSocketUser || (targetSocketId.substring(0, 4) + '...')}`;
      bubble.appendChild(meta);

      // ë³¸ë¬¸
      const textEl = document.createElement('div');
      textEl.className = 'text';
      textEl.textContent = chat;
      bubble.appendChild(textEl);

      // ë‹µì¥ ë²„íŠ¼ (ìƒëŒ€ì—ê²Œ ë°”ë¡œ ë‹µì¥í•  ìˆ˜ ìˆê²Œ)
      const actions = document.createElement('div');
      actions.className = 'actions';
      const replyBtn = document.createElement('button');
      replyBtn.type = 'button';
      replyBtn.className = 'btn btn-light whisper-reply';
      replyBtn.dataset.socketId = targetSocketId;
      replyBtn.dataset.user = targetSocketUser;
      replyBtn.textContent = 'ë‹µì¥';
      actions.appendChild(replyBtn);
      bubble.appendChild(actions);

      div.appendChild(bubble);
      chatList.appendChild(div);
      div.scrollIntoView({ block: 'end' }); // ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤

      // í¼ ë¦¬ì…‹
      this.chat.value = '';
      this.targetSocketId.value = '';
      this.style.display = 'none';
    })
    .catch(console.error);
  }
});

</script>
