
<h1 class="room-title"><%= title || 'GIF ì±„íŒ…ë°©' %></h1>
<div class="room-actions">
  <a href="/" id="exit-btn" class="btn">ë°© ë‚˜ê°€ê¸°</a>
  <a href="/" id="join-room-btn" class="btn">ì°¸ì—¬í•˜ê¸°</a>
  <a href="/" id="invite-friend-btn" class="btn">ì´ˆëŒ€í•˜ê¸°</a>
</div>

<section class="chat-panel">
  <div id="chat-list" class="chat-list">
    <% chats.forEach(function(chat){ 
         const type = chat.chatType || 'local';
         const from = chat.user || chat.from;
         const fromUserId = chat.userId;
         const to   = chat.to || '';
         const isSystem = chat.user === 'system';
         const isMine = String(from) === String(user.nick);
         const isWhisper = type === 'whisper';
         const isBroadcast = type === 'broadcast';
         const typeClass = isWhisper ? 'type-whisper' : (isBroadcast ? 'type-broadcast' : 'type-local');
         const isFriend = chat.isFriend || false;
         const friendStatus = chat.friendStatus || '';

         const sock = chat.socketId || '';
         const shortSock = sock ? `${sock.substring(0,4)}...` : '';
    %>
      <div 
        class="message <%= isSystem ? 'system' : (isMine ? 'mine' : 'other') %> <%= typeClass %>"
        <% if (isWhisper) { %>
          data-reply-socket-id="<%= sock %>" 
          data-reply-user="<%= from %>"
          data-reply-fromuser-id="<%= fromUserId %>"
          data-reply-isfriend="<%= isFriend %>"
          data-reply-friend-status="<%= friendStatus %>"
        <% } %>
      >
        <% /* ë°©ì†¡ì¼ ë•Œë„ ì•„ë°”íƒ€ ìˆ¨ê¹€: not isSystem && not isWhisper && not isBroadcast */ %>
        
        <% if (!isSystem && !isWhisper && !isBroadcast) { %>
        <div class="avatar" style="--avatar-color:<%= chat.color || '#888' %>;">
          <%= (String(from||'U').charAt(0) || 'U').toUpperCase() %>

          <% if (isFriend) { %>
            <img
              src="/images/free-icon-friend.png"
              alt="friend"
              class="friend-icon"
              data-fromuser-id="<%= fromUserId %>"
              data-user="<%= from %>"
              data-friend-status="<%= friendStatus %>"
              data-isfriend="<%= isFriend %>"
            >
          <% } %>
        </div>
      <% } %>

        <div class="bubble <%= isBroadcast ? 'broadcast-bubble' : '' %>">
          <% if (isWhisper) { %>
            <!-- ê·“ì†ë§ -->
            <div class="meta">[ê·“ì†ë§] <%= from || sock %> â†’ <%= isMine ? (to || 'ìƒëŒ€') : 'ë‚˜' %></div>
            <div class="text"><%= chat.chat %></div>
            <% if (!isMine) { %>
              <div class="actions">
                <button type="button" class="btn btn-light whisper-reply"
                  data-socket-id="<%= sock %>"
                  data-user="<%= from %>"
                  data-isfriend ="<%= isFriend %>"
                  data-friend-status="<%= friendStatus %>"
                  data-fromuser-id="<%= fromUserId %>">ë‹µì¥</button>
              </div>
            <% } %>
          <% } else if (isBroadcast) { %>
            <!-- ë°©ì†¡: ì „ì²´ í­ + ì™¸ì¹˜ê¸° ì•„ì´ì½˜ -->
            <div class="meta">
              <span class="shout-icon" aria-hidden="true">ğŸ“¢</span>
              <span class="badge type-broadcast">ë°©ì†¡</span>
              <span class="route"><%= from || 'Guest' %> â†’ ëª¨ë‘</span>
              <span class="sock socket-id-display" data-socket-id="<%= sock %>" 
                            data-fromuser-id="<%= fromUserId %>" data-isfriend="<%=isFriend%>" data-friend-status="<%= friendStatus %>"><%= shortSock ? '(' + shortSock + ')' : '' %></span>
            </div>
            <% if (chat.gif) { %>
              <img class="bubble-gif" src="/gif/<%= chat.gif %>" alt="gif">
            <% } else { %>
              <div class="text"><%= chat.chat %></div>
            <% } %>

          <% } else { %>
            <!-- ì¼ë°˜(local) -->
            <% if (!isSystem) { %>
              <div class="meta">
                <span class="name socket-id-display" data-socket-id="<%= sock %>" data-fromuser-id="<%= fromUserId %>" data-isfriend="<%=isFriend%>" data-friend-status="<%= friendStatus %>">
                  <%= from || 'Guest' %> <%= shortSock ? '(' + shortSock + ')' : '' %>
                </span>
                <% if (isFriend) { %>
                <span class="badge badge-friend"
                      title="<%= friendStatus || 'accepted' %>"
                      data-fromuser-id="<%= fromUserId %>"
                      data-user="<%= from %>"
                      data-isfriend="<%=isFriend%>"
                      data-friend-status="<%= friendStatus %>">ì¹œêµ¬</span>
              <% } %>
                <span class="badge type-local">ì¼ë°˜</span>
              </div>
            <% } %>
            <% if (chat.gif) { %>
              <img class="bubble-gif" src="/images/<%= chat.gif %>" alt="gif">
            <% } else { %>
              <div class="text"><%= chat.chat %></div>
            <% } %>
          <% } %>
        </div>
      </div>
    <% }) %>
  </div>
</section>

<!-- âœ… ë©”ì‹œì§€ ìš°í´ë¦­ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ -->
<div id="msg-context" class="context-menu" hidden>
  <button type="button" class="context-item" data-action="whisper">ê·“ì†ë§</button>
  <button type="button" class="context-item" data-action="friend">ì¹œêµ¬ìš”ì²­</button>
</div>

<!-- âœ… ì´ˆëŒ€ ëª¨ë‹¬ -->
<div id="invite-modal" class="modal" hidden>
  <div class="modal-backdrop"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="invite-modal-title">
    <div class="modal-header">
      <h2 id="invite-modal-title">ì¹œêµ¬ ì´ˆëŒ€</h2>
      <button type="button" class="modal-close" aria-label="ë‹«ê¸°">âœ•</button>
    </div>

    <div class="modal-body">
      <div class="invite-toolbar">
        <input id="invite-search" type="text" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰â€¦" />
        <button id="invite-reload" type="button" class="btn btn-light">ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <div id="invite-list" class="invite-list">
      </div>

      <div class="invite-footer">
        <label class="select-all">
          <input type="checkbox" id="invite-select-all" />
          ì „ì²´ ì„ íƒ
        </label>
        <div class="spacer"></div>
        <button id="invite-send" class="btn btn-primary" type="button">ì´ˆëŒ€ ë³´ë‚´ê¸°</button>
        <button id="invite-cancel" class="btn btn-light" type="button">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>
</div>

  <!-- ì…ë ¥ì˜ì—­(ì‘ì€ í™”ë©´ì—ì„œëŠ” í•­ìƒ í•˜ë‹¨ ê³ ì •) -->
  <div class="composer">
    <form action="/chat" id="chat-form" method="post" enctype="multipart/form-data" class="composer-row">
      <label for="gif" class="btn btn-light">GIF</label>
      <input type="file" id="gif" name="gif" accept="image/gif" hidden>
      <input type="text" id="chat" name="chat" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦">
      <button type="submit" class="btn btn-primary">ì „ì†¡</button>
    </form>

    <form action="/broadcastchat" id="broadcastchat-form" method="post" class="composer-row">
      <label class="composer-label" for="broadcastchat-input">ì™¸ì¹˜ê¸°</label>
      <input type="text" id="broadcastchat-input" name="chat" placeholder="ëª¨ë‘ì—ê²Œ ì™¸ì¹˜ê¸°">
      <button type="submit" class="btn">ì „ì†¡</button>
    </form>

    <!-- ê·“ì†ë§ -->
    <form action="/whisperchat" id="whisperchat-form" method="post" class="composer-row whisper" style="display:none;">
      <input type="hidden" id="whisper-target-socketid" name="targetSocketId">
      <input type="hidden" id="whisper-source-user" name="sourceSocketUser" value="<%=user.nick%>">
      <input type="hidden" id="whisper-source-userid" name="sourceSocketUserId" value="<%=user._id%>">
      <input type="hidden" id="whisper-target-user" name="targetSocketUser">
      <span class="whisper-target">ëŒ€ìƒ: <strong id="whisper-target-display"></strong></span>
      <input type="text" id="whisper-chat-input" name="chat" placeholder="ê·“ì†ë§ ë‚´ìš©">
      <button type="submit" class="btn btn-accent">ê·“ì†ë§ ì „ì†¡</button>
      <button type="button" id="whisper-cancel-btn" class="btn btn-light">ì·¨ì†Œ</button>
    </form>
  </div>

<!-- ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš© (socket, axios ë“±) -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  const glimpse = JSON.parse('<%- JSON.stringify(glimpse) %>');
  
  if (glimpse=== true) {
    document.querySelector('.composer').style.display = 'none';
  }else{
    const joinBtn = document.getElementById('join-room-btn');
    if (joinBtn) {
      joinBtn.style.display = 'none';
    }
  }

</script>
<script>
  const socket = io('/chat', { path: '/socket.io', withCredentials: true });
  const chatList = document.querySelector('#chat-list');
  const whisperForm = document.querySelector('#whisperchat-form');
  const whisperCancelBtn = document.querySelector('#whisper-cancel-btn');
  const whisperTargetDisplay = document.querySelector('#whisper-target-display');
  const whisperTargetSocketId = document.querySelector('#whisper-target-socketid');
  const whisperChatInput = document.querySelector('#whisper-chat-input');
  const myUser = {
    id: '<%= user._id %>',
    nick: '<%= user.nick %>',
  };


  socket.on('connect', () => {
    const roomId = new URL(location).pathname.split('/').at(-1);
    socket.emit('join', {roomId, user:myUser});
  });

  // ì‹œìŠ¤í…œ ë©”ì‹œì§€
  ['join','exit', 'leave'].forEach(evt => {
    socket.on(evt, data => {
      const div = document.createElement('div');
      div.className = 'message system';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = data.chat;
      div.appendChild(bubble);
      chatList.appendChild(div);
      chatList.scrollTop = chatList.scrollHeight;
    });
  });


  // ê·“ì†ë§ ìˆ˜ì‹ 
socket.on('whisper', data => {
  // data: { fromSocketId, fromUser, chat }
  const div = document.createElement('div');
  // ê¸°ì¡´ í´ë˜ìŠ¤ + íƒ€ì… êµ¬ë¶„ í´ë˜ìŠ¤ ì¶”ê°€
  div.className = 'message system whisper-in type-whisper';

  const friends = data.friends;
  const isFriend = !!(friends && friends[myUser.id]);
  const friendStatus = isFriend? 'accepted' : '';

  // ë‹µì¥ì— ì“°ê¸° ìœ„í•´ ë°ì´í„° ë³´ê´€
  div.dataset.replySocketId = data.fromSocketId || '';
  div.dataset.replyUser = data.fromUser || '';
  div.dataset.replyfromuserId = data.chat.userId || ''; 
  div.dataset.isfriend = isFriend;
  div.dataset.friendStatus = friendStatus;

  const bubble = document.createElement('div');
  bubble.className = 'bubble whisper-bubble'; // ë²„ë¸”ì—ë„ íƒ€ì… í´ë˜ìŠ¤ ì¶”ê°€

  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.innerHTML = `[ê·“ì†ë§] ${data.fromUser || data.fromSocketId} â†’ ë‚˜`;
  bubble.appendChild(meta);

  const text = document.createElement('div');
  text.className = 'text';
  text.textContent = data.chat || '';
  bubble.appendChild(text);

  // ë‹µì¥ ë²„íŠ¼
  const actions = document.createElement('div');
  actions.className = 'actions';
  const replyBtn = document.createElement('button');
  replyBtn.type = 'button';
  replyBtn.className = 'btn btn-light whisper-reply';
  replyBtn.dataset.socketId = data.fromSocketId || '';
  replyBtn.dataset.user = data.fromUser || '';
  replyBtn.dataset.fromuserId = data.chat.userId || ''; 
  replyBtn.dataset.isfriend = isFriend;
  replyBtn.dataset.friendStatus = friendStatus;
  replyBtn.textContent = 'ë‹µì¥';
  actions.appendChild(replyBtn);
  bubble.appendChild(actions);

  div.appendChild(bubble);
  chatList.appendChild(div);

  // ë¶€ë“œëŸ½ê²Œ ë§¨ ì•„ë˜ë¡œ
  div.scrollIntoView({ block: 'end' });
});


async function checkIsFriend(requester, addressee){/** 1) ìˆ˜ë½ëœ ì¹œêµ¬ ëª©ë¡ API */
  const { data } = await axios.post('/friend/isfriend',{requester:requester, addressee:addressee});
  return data.isFriend;
};


  // ì¼ë°˜/ì‹¤ì‹œê°„ ì±„íŒ…
socket.on('chat', function (data) {
  // ì„œë²„ì—ì„œ ì˜¤ëŠ” í˜•íƒœì— ë”°ë¼ ë°©ì–´ì ìœ¼ë¡œ êº¼ë‚´ê¸°
  const doc = data.chat || data;
  const friends = data.friends;

  // í‘œì‹œì— í•„ìš”í•œ ì •ë³´ ì¶”ì¶œ
  const fromUser   = doc.user || data.user || 'Guest';
  const fromUserId = doc.userId || (data.chat && data.chat.userId) || data.fromUserId || '';
  const isMine     = data.socketId && socket.id === data.socketId;
  const isFriend = !!(friends && friends[myUser.id]);
  const friendStatus = isFriend? 'accepted' : '';

  const item = document.createElement('div');
  item.className = 'message ' + (isMine ? 'mine' : 'other');

  // ì•„ë°”íƒ€ (ë‚´ ë©”ì‹œì§€ëŠ” ìˆ¨ê¹€ ìœ ì§€)
  if (!isMine) {
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.style.setProperty('--avatar-color', doc.color || '#888'); // CSS ë³€ìˆ˜ ì‚¬ìš© ì‹œ
    avatar.style.backgroundColor = doc.color || '#888';              // ë°°ê²½ ì§ì ‘ ì§€ì •ë„ ìœ ì§€
    avatar.textContent = String(fromUser || 'U').charAt(0).toUpperCase();

    // âœ… ì¹œêµ¬ ì•„ì´ì½˜ ì˜¤ë²„ë ˆì´
    if (isFriend) {
      const friendImg = document.createElement('img');
      friendImg.src = '/images/free-icon-friend.png';
      friendImg.alt = 'friend';
      friendImg.className = 'friend-icon';
      friendImg.dataset.fromuserId   = fromUserId;
      friendImg.dataset.user         = fromUser;
      friendImg.isFriend             = isFriend;
      friendImg.dataset.friendStatus = friendStatus;
      avatar.appendChild(friendImg);
    }

    item.appendChild(avatar);
  }

  const bubble = document.createElement('div');
  bubble.className = 'bubble';

  const meta = document.createElement('div');
  meta.className = 'meta';

  // ì´ë¦„(ì†Œì¼“ID)
  const name = document.createElement('span');
  name.className = 'name socket-id-display';
  name.dataset.socketId   = data.socketId || '';
  name.dataset.fromuserId = fromUserId || '';
  name.dataset.isfriend   = String(isFriend);
  name.dataset.friendStatus = friendStatus;
  name.textContent = `${fromUser} ${data.socketId ? '(' + String(data.socketId).substring(0,4) + '...)' : ''}`;
  meta.appendChild(name);

  // âœ… ì¹œêµ¬ ë°°ì§€ ì¶”ê°€
  if (isFriend) {
    const badge = document.createElement('span');
    badge.className = 'badge badge-friend';
    badge.title = friendStatus; // ì˜ˆ: accepted/requested ë“±
    badge.dataset.fromuserId   = fromUserId || '';
    badge.dataset.user         = fromUser;
    badge.dataset.isfriend     = isFriend;
    badge.dataset.friendStatus = friendStatus;
    badge.textContent = 'ì¹œêµ¬';
    meta.appendChild(badge);
  }

  // íƒ€ì… ë°°ì§€(ê¸°ì¡´ ë¡œì§ ìœ ì§€)
  const typeBadge = document.createElement('span');
  typeBadge.className = 'badge type-local';
  typeBadge.textContent = 'ì¼ë°˜';
  meta.appendChild(typeBadge);

  bubble.appendChild(meta);

  // ë³¸ë¬¸
  if (doc.gif) {
    const img = document.createElement('img');
    img.className = 'bubble-gif';
    img.src = '/images/free-icon-friend.png'; //+ doc.gif;
    img.alt = 'gif';
    bubble.appendChild(img);
  } else if (doc.chat) {
    const text = document.createElement('div');
    text.className = 'text';
    text.textContent = doc.chat;
    bubble.appendChild(text);
  }

  item.appendChild(bubble);
  chatList.appendChild(item);
  chatList.scrollTop = chatList.scrollHeight;
});

function displayChat(
        doc,
        fromUser,
        fromUserId,
        isMine,
        isFriend,
        friendStatus){

  //alert(`friendStatus :${friendStatus}`);

  const item = document.createElement('div');
  item.className = 'message ' + (isMine ? 'mine' : 'other');

  // ì•„ë°”íƒ€ (ë‚´ ë©”ì‹œì§€ëŠ” ìˆ¨ê¹€ ìœ ì§€)
  if (!isMine) {
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.style.setProperty('--avatar-color', doc.color || '#888'); // CSS ë³€ìˆ˜ ì‚¬ìš© ì‹œ
    avatar.style.backgroundColor = doc.color || '#888';              // ë°°ê²½ ì§ì ‘ ì§€ì •ë„ ìœ ì§€
    avatar.textContent = String(fromUser || 'U').charAt(0).toUpperCase();

    // âœ… ì¹œêµ¬ ì•„ì´ì½˜ ì˜¤ë²„ë ˆì´
    if (isFriend) {
      const friendImg = document.createElement('img');
      friendImg.src = '/images/free-icon-friend.png';
      friendImg.alt = 'friend';
      friendImg.className = 'friend-icon';
      friendImg.dataset.fromuserId   = fromUserId;
      friendImg.dataset.user         = fromUser;
      friendImg.isFriend             = isFriend;
      friendImg.dataset.friendStatus = friendStatus;
      avatar.appendChild(friendImg);
    }

    item.appendChild(avatar);
  }

  const bubble = document.createElement('div');
  bubble.className = 'bubble';

  const meta = document.createElement('div');
  meta.className = 'meta';

  // ì´ë¦„(ì†Œì¼“ID)
  const name = document.createElement('span');
  name.className = 'name socket-id-display';
  name.dataset.socketId   = data.socketId || '';
  name.dataset.fromuserId = fromUserId || '';
  name.dataset.isfriend   = String(isFriend);
  name.dataset.friendStatus = friendStatus || '';
  name.textContent = `${fromUser} ${data.socketId ? '(' + String(data.socketId).substring(0,4) + '...)' : ''}`;
  meta.appendChild(name);

  // âœ… ì¹œêµ¬ ë°°ì§€ ì¶”ê°€
  if (isFriend) {
    const badge = document.createElement('span');
    badge.className = 'badge badge-friend';
    badge.title = friendStatus; // ì˜ˆ: accepted/requested ë“±
    badge.dataset.fromuserId   = fromUserId || '';
    badge.dataset.user         = fromUser;
    badge.dataset.isfriend     = 'true';
    badge.dataset.friendStatus = friendStatus;
    badge.textContent = 'ì¹œêµ¬';
    meta.appendChild(badge);
  }

  // íƒ€ì… ë°°ì§€(ê¸°ì¡´ ë¡œì§ ìœ ì§€)
  const typeBadge = document.createElement('span');
  typeBadge.className = 'badge type-local';
  typeBadge.textContent = 'ì¼ë°˜';
  meta.appendChild(typeBadge);

  bubble.appendChild(meta);

  // ë³¸ë¬¸
  if (doc.gif) {
    const img = document.createElement('img');
    img.className = 'bubble-gif';
    img.src = '/images/free-icon-friend.png'; //+ doc.gif;
    img.alt = 'gif';
    bubble.appendChild(img);
  } else if (doc.chat) {
    const text = document.createElement('div');
    text.className = 'text';
    text.textContent = doc.chat;
    bubble.appendChild(text);
  }

  item.appendChild(bubble);
  chatList.appendChild(item);
  chatList.scrollTop = chatList.scrollHeight;
}

  // ë°©ì†¡ ì±„íŒ…
socket.on('broadcastchat', data => {

  const doc = data.chat || data;
  const friends = data.friends;

  // í‘œì‹œì— í•„ìš”í•œ ì •ë³´ ì¶”ì¶œ
  const fromUser   = doc.user || data.user || 'Guest';
  const fromUserId = doc.userId || (data.chat && data.chat.userId) || data.fromUserId || '';
  const isMine     = data.socketId && socket.id === data.socketId;
  const isFriend = !!(friends && friends[myUser.id]);
  const friendStatus = isFriend? 'accepted' : '';
  const socketId = data.socketId;

  // data: { user, chat, gif, socketId? }
  const item = document.createElement('div');
  item.className = 'message system type-broadcast';   // ì „ì²´ í­ + ì¤‘ì•™ ì •ë ¬

  const bubble = document.createElement('div');
  bubble.className = 'bubble broadcast-bubble';       // ë°©ì†¡ ì „ìš© ë²„ë¸” ìŠ¤íƒ€ì¼

  // ë©”íƒ€: ğŸ“¢ ì•„ì´ì½˜ + ë°©ì†¡ ë°°ì§€ + ë¼ìš°íŒ… + (ì„ íƒ) ì†Œì¼“ID
  const meta = document.createElement('div');
  meta.className = 'meta';

  const icon = document.createElement('span');
  icon.className = 'shout-icon';
  icon.textContent = 'ğŸ“¢';

  const badge = document.createElement('span');
  badge.className = 'badge type-broadcast';
  badge.textContent = 'ë°©ì†¡';

  const route = document.createElement('span');
  route.className = 'route';
  route.textContent = `${data.user || 'Guest'} â†’ ëª¨ë‘`;

  meta.append(icon, badge, route);

  // (ì„ íƒ) ì§§ì€ ì†Œì¼“ID í‘œì‹œ
  if (socketId) {
    const shortSock = `${String(socketId).substring(0,4)}...`;
    const sock = document.createElement('span');
    sock.className = 'sock socket-id-display';
    sock.dataset.isMine = isMine;
    sock.dataset.socketId = socketId;
    sock.dataset.fromuserId = fromUserId || ''; 
    sock.dataset.isfriend = isFriend;
    sock.dataset.friendStatus = friendStatus;
    sock.textContent = ` (${shortSock})`;
    meta.appendChild(sock);
  }

  bubble.appendChild(meta);

  // ë³¸ë¬¸/ì´ë¯¸ì§€
  if (data.chat) {
    const text = document.createElement('div');
    text.className = 'text';
    text.textContent = doc.chat;     // XSS ì•ˆì „
    bubble.appendChild(text);
  }
  if (data.gif) {
    const img = document.createElement('img');
    img.className = 'bubble-gif';
    img.src = `/gif/${data.gif}`;
    img.alt = 'gif';
    bubble.appendChild(img);
  }

  item.appendChild(bubble);
  chatList.appendChild(item);
  item.scrollIntoView({ block: 'end' });
});

  const whisperTargetUserInput = document.querySelector('#whisper-target-user');
  
  function openWhisperForm(targetId, fromUser) {
    if (!targetId) return;
    if (targetId === socket.id) {
      alert('ìê¸° ìì‹ ì—ê²ŒëŠ” ê·“ì†ë§ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    const shortSock = targetId.substring(0, 4) + '...';
    whisperTargetSocketId.value = targetId;
    whisperTargetDisplay.textContent = fromUser ? `${fromUser} (${shortSock})` : shortSock;
    whisperForm.style.display = 'grid';

    whisperTargetUserInput.value = fromUser || '';

    whisperChatInput.focus();
  }

  chatList.addEventListener('click', (e) => {
    // 1) "ë‹µì¥" ë²„íŠ¼ (ê°€ì¥ ìš°ì„ )
    const replyBtn = e.target.closest('.whisper-reply');
    if (replyBtn) {
      const targetId = replyBtn.dataset.socketId || '';
      const fromUser = replyBtn.dataset.user || '';
      openWhisperForm(targetId, fromUser);
      return; // ë” ì´ìƒ ì „íŒŒ ì²˜ë¦¬ X
    }

    // 2) ì¼ë°˜ ë©”ì‹œì§€ì˜ "ì´ë¦„(ì†Œì¼“ID)" í´ë¦­
    const socketSpan = e.target.closest('.socket-id-display');
    if (socketSpan) {
      const targetId = socketSpan.dataset.socketId || '';
      const fromUser = socketSpan.textContent?.trim().split(' (')[0] || '';
      const fromUserId = socketSpan.dataset.fromuserId || '';

      if (!targetId) {
      //  alert('ìœ íš¨í•œ ì†Œì¼“ IDê°€ ì—†ìŠµë‹ˆë‹¤. :' + fromUserId);
        return;
      }
      
      const whisperForm = document.querySelector('#whisperchat-form');
      const whisperTargetUser = whisperForm.querySelector('#whisper-target-user');
      whisperTargetUser.value = fromUser || '';  // ì˜ˆ: ê·“ì†ë§ ëŒ€ìƒì˜ ë‹‰ë„¤ì„

      openWhisperForm(targetId, fromUser);
      return;
    }

    // 3) ìˆ˜ì‹ í•œ ê·“ì†ë§ì˜ ë²„ë¸” í´ë¦­
    const whisperMsg = e.target.closest('.message.whisper-in');
    if (whisperMsg && whisperMsg.querySelector('.bubble')?.contains(e.target)) {
      const targetId = whisperMsg.dataset.replySocketId || '';
      const fromUser = whisperMsg.dataset.replyUser || '';
      const fromUserId = whisperMsg.dataset.replyfromuserId || '';
      openWhisperForm(targetId, fromUser);
      return;
    }
  });

  whisperCancelBtn.addEventListener('click', () => {
    whisperForm.style.display = 'none';
    whisperTargetSocketId.value = '';
    whisperChatInput.value = '';
  });

  // ì „ì†¡ í•¸ë“¤ëŸ¬
  document.querySelector('#chat-form').addEventListener('submit', function (e) {
    e.preventDefault();
    if (this.chat.value) {
      axios.post('/room/<%= room._id %>/chat', { chat: this.chat.value })
        .then(() => { this.chat.value=''; })
        .catch(console.error);
    }
  });

  document.querySelector('#broadcastchat-form').addEventListener('submit', function (e) {
    e.preventDefault();
    if (this.chat.value) {
      axios.post('/room/<%= room._id %>/broadcastchat', { chat: this.chat.value })
        .then(() => { this.chat.value=''; })
        .catch(console.error);
    }
  });

  document.querySelector('#gif').addEventListener('change', e => {
    const file = e.target.files?.[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('gif', file);
    axios.post('/room/<%= room._id %>/gif', formData)
      .then(() => { e.target.value = null; })
      .catch(console.error);
  });


document.querySelector('#whisperchat-form').addEventListener('submit', function (e) {
  e.preventDefault();

  const targetSocketId = this.targetSocketId.value?.trim();
  const chat = this.chat.value?.trim();
  const targetSocketUser = this.targetSocketUser.value?.trim();
  const sourceSocketUser = this.sourceSocketUser.value?.trim();

  if (targetSocketId && chat) {
    axios.post('/room/<%= room._id %>/whisperchat', {
      targetSocketId,
      targetSocketUser,
      sourceSocketUser,
      chat,
    })
    .then(() => {
      // ë‚´ í™”ë©´ì—ë„ "ë‚´ê°€ ë³´ë‚¸ ê·“ì†ë§" í‘œì‹œ
      const div = document.createElement('div');
      div.className = 'message system whisper-out type-whisper'; // í†µì¼ëœ íƒ€ì… í´ë˜ìŠ¤ ì¶”ê°€

      // ë‹µì¥ìš© ë°ì´í„° ë³´ê´€
      div.dataset.replySocketId = targetSocketId;
      div.dataset.replyUser = targetSocketUser;

      const bubble = document.createElement('div');
      bubble.className = 'bubble whisper-bubble'; // ë²„ë¸” íƒ€ì… í´ë˜ìŠ¤

      // meta: ë³´ë‚¸ ìª½ì´ë¯€ë¡œ ë‚˜ â†’ ìƒëŒ€
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `[ê·“ì†ë§] ë‚˜ â†’ ${targetSocketUser || (targetSocketId.substring(0, 4) + '...')}`;
      bubble.appendChild(meta);

      // ë³¸ë¬¸
      const textEl = document.createElement('div');
      textEl.className = 'text';
      textEl.textContent = chat;
      bubble.appendChild(textEl);

      // ë‹µì¥ ë²„íŠ¼ (ìƒëŒ€ì—ê²Œ ë°”ë¡œ ë‹µì¥í•  ìˆ˜ ìˆê²Œ)
      const actions = document.createElement('div');
      actions.className = 'actions';
      bubble.appendChild(actions);

      div.appendChild(bubble);
      chatList.appendChild(div);
      div.scrollIntoView({ block: 'end' }); // ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤

      // í¼ ë¦¬ì…‹
      this.chat.value = '';
      this.targetSocketId.value = '';
      this.style.display = 'none';
    })
    .catch(console.error);
  }
});

// âœ… â‘¢ ë°© ë‚˜ê°€ê¸° í•¸ë“¤ëŸ¬ ì¶”ê°€ (ì´ ì½”ë“œ)
  (function() {
    const exitBtn = document.getElementById('exit-btn');
    if (!exitBtn) return;

    exitBtn.addEventListener('click', async(e) => {
      e.preventDefault();
      const href = exitBtn.getAttribute('href') || '/';
      const roomId = new URL(location).pathname.split('/').at(-1);

       // ì‚¬ìš©ì ì •ë³´ (EJSì—ì„œ user ê°ì²´ë¥¼ ì„œë²„ ë Œë”ë§ ì‹œ ì£¼ì…í–ˆë‹¤ê³  ê°€ì •)
      const userInfo = {
        id: '<%= user._id %>',
        nick: '<%= user.nick %>',
      };


    let moved = false;
    const move = () => { if (!moved) { moved = true; location.assign(href); } };

      try {
        const res = await axios.post(`/room/${roomId}/leave`, {
            userId:userInfo.id,
            nick:userInfo.nick
        }).then((res)=>{
          if(res.status === 200)
            alert(`${res.data.message ? '(' + res.data.message + ')' : ''}`);
          else if(res.status === 201)
            alert(`${ctx.user}ë‹˜ ${res.data.message ? '(' + res.data.message + ')' : ''}`);
          else
            alert('ë°©ë‚˜ê°€ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (res.data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }).catch(err=>{
          console.error(err);
          alert('ë°© ë‚˜ê°€ê¸° ìš”ì²­ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
      } catch (err) {
          console.error(err);
          alert('ë°© ë‚˜ê°€ê¸° ìš”ì²­ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }finally{
        move();
      }
  })
})();

  // ì—¿ë³´ê¸° í•˜ë‹¤ ëŒ€íšŒì— ì°¸ì—¬í•˜ê¸°
  (function() {
    const joinBtn = document.getElementById('join-room-btn');
    if (!joinBtn) return;

    joinBtn.addEventListener('click', (e) => {
      e.preventDefault();

      // const glimpse = JSON.parse('<%- JSON.stringify(glimpse) %>');
  
      // if (glimpse=== true) {
        document.querySelector('.composer').style.display = 'block';
      //}

      const roomId = '<%= room._id %>';
      location.assign(`/room/${roomId}`);

    });
  })();


  (function() {
    const chatList = document.getElementById('chat-list');
    const menu = document.getElementById('msg-context');

    /** í˜„ì¬ ì»¨í…ìŠ¤íŠ¸ ëŒ€ìƒ ì €ì¥ */
    let ctx = { socketId: '', user: '', fromUserId: '', isFriend: false };

    /** ëŒ€ìƒ ì¶”ì¶œ: ìš°í´ë¦­í•œ ìš”ì†Œ ê¸°ì¤€ìœ¼ë¡œ socketId/ë‹‰ë„¤ì„ ì°¾ê¸° */
    function extractTargetInfo(target) {
      // 1) ê·“ì†ë§ë¡œ ì˜¨ ë©”ì‹œì§€ì˜ ë£¨íŠ¸ (ìˆ˜ì‹ )
      const whisperIn = target.closest('.message.whisper-in');
      if (whisperIn && (whisperIn.dataset.replySocketId || whisperIn.dataset.replyUser || whisperIn.dataset.replyfromuserId)) {
        return {
          socketId: whisperIn.dataset.replySocketId || '',
          user: whisperIn.dataset.replyUser || '',
          userId: whisperIn.dataset.replyfromuserId || '',
          isFriend: whisperIn.dataset.isfriend === 'true' || false,
          friendStatus: whisperIn.dataset.friendStatus
        };
      }

      // 2) ì¼ë°˜/ë°©ì†¡ ë©”ì‹œì§€ì˜ "ì´ë¦„(ì†Œì¼“ID)" ì˜ì—­
      const sockSpan = target.closest('.socket-id-display');
      if (sockSpan) {
        const socketId = sockSpan.dataset.socketId || '';
        const fromUserId = sockSpan.dataset.fromuserId || '';
        const isFriend = sockSpan.dataset.isfriend === 'true' || false;
        const friendStatus = sockSpan.dataset.friendStatus;

        // í…ìŠ¤íŠ¸: "ë‹‰ë„¤ì„ (ABCD...)" í˜•íƒœì¼ ìˆ˜ ìˆìŒ
        const raw = (sockSpan.textContent || '').trim();
        const user = raw.split(' (')[0] || '';
        return { socketId, user, fromUserId, isFriend, friendStatus };
      }

      // 3) ë©”ì‹œì§€ ë£¨íŠ¸ì—ì„œ socket-id-display ì°¾ê¸° (ë²„ë¸” ë‚´ë¶€ ë“±)
      const msg = target.closest('.message');
      if (msg) {
        const inner = msg.querySelector('.socket-id-display');
        if (inner) {
          const socketId = inner.dataset.socketId || '';
          const fromUserId = inner.dataset.fromuserId || '';
          const isFriend = inner.dataset.isfriend === 'true' || false;
          const friendStatus = inner.dataset.friendStatus;
          const raw = (inner.textContent || '').trim();
          const user = raw.split(' (')[0] || '';
          return { socketId, user, fromUserId, isFriend, friendStatus };
        }
      }

      return { socketId: '', user: '', fromUserId: '', isFriend: false, friendStatus: '' };
    }

    /** ë©”ë‰´ í‘œì‹œ */
    function showMenu(x, y) {
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.hidden = false;
    }
    /** ë©”ë‰´ ìˆ¨ê¹€ */
    function hideMenu() {
      menu.hidden = true;
      ctx = { socketId: '', user: '' };
    }

    /** ë·°í¬íŠ¸ ë°–ìœ¼ë¡œ ì‚ì ¸ë‚˜ê°€ë©´ ë³´ì • */
    function clampAndShow(x, y) {
      const pad = 6;
      const mw = 180;  // ëŒ€ëµì  ë©”ë‰´ í­
      const mh = 90;   // ëŒ€ëµì  ë©”ë‰´ ë†’ì´
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      const nx = Math.min(Math.max(pad, x), vw - mw - pad);
      const ny = Math.min(Math.max(pad, y), vh - mh - pad);
      showMenu(nx, ny);
    }

    /** ìš°í´ë¦­ ì—´ê¸° */
    chatList.addEventListener('contextmenu', (e) => {
      // ìš°í´ë¦­ ê¸°ë³¸ ë©”ë‰´ ì¤‘ë‹¨
      e.preventDefault();

      // ëŒ€ìƒ ì •ë³´ ì¶”ì¶œ
      const info = extractTargetInfo(e.target);

      if(myUser.id === info.fromUserId){
        hideMenu();
        return;
      }

      //alert(`info : ${info.isFriend} : ${info.friendStatus}`);

      // socketIdê°€ ì—†ê±°ë‚˜ ë‚´ ë©”ì‹œì§€(ë‚´ ì†Œì¼“)ë¼ë©´ ë©”ë‰´ ë„ìš°ì§€ ì•ŠìŒ
      if (!info.socketId && !info.fromUserId) { hideMenu(); return; }

      if(info.socketId){
        if (info.socketId === (socket && socket.id)) { //ë‚˜ ìì‹ ì¸ ê²½ìš°
          hideMenu(); 
          return; 
        }
        else{ //ë‹¤ë¥¸ ì‚¬ëŒì¸ ê²½ìš°
          //alert(`socket exist: isFriend ${info.isFriend}`);
          toggleButton('friend', !info.isFriend);

          toggleButton('whisper', true);  //ê·“ì†ë§ ë³´ì´ê¸°
        }
      }else{
        //ê·“ì†ë§ ë©”ë‰´ display:none
        toggleButton('whisper');

        if(info.isFriend){
          hideMenu(); return;
        }else{
          toggleButton('friend', true);
        }
      }

      ctx = info; // ì €ì¥
      clampAndShow(e.clientX, e.clientY);
    });

    /** ë©”ë‰´ í•­ëª© í´ë¦­ */
    menu.addEventListener('click', async (e) => {
      const btn = e.target.closest('.context-item');
      if (!btn) return;
      
      const action = btn.dataset.action;

      // ì•ˆì „ ê°€ë“œ
      //if (!ctx.socketId) { hideMenu(); return; }

      if (action === 'whisper') {
        if (!ctx.socketId) { hideMenu(); return; }

        // ê¸°ì¡´ ë¡œì§ ì¬ì‚¬ìš©
        openWhisperForm(ctx.socketId, ctx.user);
        hideMenu();
        return;
      }

      if (action === 'friend') {
        try {
          if (!ctx.fromUserId) { hideMenu(); return; } 
          
         // alert(`ì¹œêµ¬ ìš”ì²­ ë³´ëƒ„:\në‹‰ë„¤ì„: ${ctx.user}\nìœ ì €ID: ${ctx.fromUserId}`);
          const res = await axios.post('/friend/request', {
            addresseeNick: ctx.user || undefined,
            addresseeId: ctx.fromUserId || undefined,
          });
      
          if(res.status === 200){
            alert(`${res.data.message ? '(' + res.data.message + ')' : ''}`);
          }else if(res.status === 201){
            alert(`${ctx.user}ë‹˜ ${res.data.message ? '(' + res.data.message + ')' : ''}`);
          }
          else{
            alert('ì¹œêµ¬ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (res.data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
        } catch (err) {
          console.error(err);
          alert('ì¹œêµ¬ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
          hideMenu();
        }
        return;
      }
    });

    /** ë©”ë‰´ ì™¸ë¶€ í´ë¦­/ìŠ¤í¬ë¡¤/ESCë¡œ ë‹«ê¸° */
    document.addEventListener('click', (e) => {
      if (!menu.hidden && !menu.contains(e.target)) hideMenu();
    });
    document.addEventListener('scroll', hideMenu, true);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hideMenu();
    });

    /** ëª¨ë°”ì¼ ë¡±í”„ë ˆìŠ¤ ëŒ€ì‘(ì„ íƒ) */
    // í•„ìš”í•˜ë©´ í„°ì¹˜ ê¸¸ê²Œ ëˆŒëŸ¬ì„œ contextmenuì™€ ë™ì¼ ë™ì‘í•˜ë„ë¡ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  })();

  function toggleButton(btnName, fshow= false){
    let btn = null;

    if('friend' === btnName)
      btn = document.querySelector('#msg-context [data-action="friend"]');
    else if('whisper' === btnName)
      btn = document.querySelector('#msg-context [data-action="whisper"]');

    if(btn){
      btn.style.display = fshow ? 'block' : 'none'; 
    }
  }
</script>

<script>
  (function () {
    const inviteBtn   = document.getElementById('invite-friend-btn');
    if (!inviteBtn) return;

    // ëª¨ë‹¬ ìš”ì†Œë“¤
    const modal       = document.getElementById('invite-modal');
    const backdrop    = modal.querySelector('.modal-backdrop');
    const closeBtn    = modal.querySelector('.modal-close');
    const cancelBtn   = document.getElementById('invite-cancel');
    const reloadBtn   = document.getElementById('invite-reload');
    const searchInput = document.getElementById('invite-search');
    const listEl      = document.getElementById('invite-list');
    const sendBtn     = document.getElementById('invite-send');
    const selectAll   = document.getElementById('invite-select-all');

    const roomId = '<%= room._id %>';

    /** 1) ìˆ˜ë½ëœ ì¹œêµ¬ ëª©ë¡ API */
    async function fetchAcceptedFriends() {
      // ì‘ë‹µ ì˜ˆ: [{ _id, nick, email?, color?, online? }, ...]
      const { data } = await axios.get('/friend/accepted');
      return Array.isArray(data) ? data : (data?.friends || []);
    }

    /** ìœ í‹¸ */
    const initial = (s) => (String(s||'U').trim()[0]||'U').toUpperCase();

    /** 2) ëª©ë¡ ë Œë”ë§ (ì²´í¬ë°•ìŠ¤ ì„ íƒí˜•) */
    function renderList(friends, keyword = '') {
      listEl.innerHTML = '';
      const q = keyword.trim().toLowerCase();

      const rows = friends.filter(f => {
        const name  = String(f.nick || f.name || '').toLowerCase();
        const email = String(f.email || '').toLowerCase();
        return !q || name.includes(q) || email.includes(q);
      });

      if (!rows.length) {
        listEl.innerHTML = `<div style="text-align:center;color:#777;padding:18px;">í‘œì‹œí•  ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      for (const f of rows) {
        const id    = String(f._id || f.id || '');
        const nick  = String(f.nick || f.name || 'ì¹œêµ¬');
        const email = f.email ? ` Â· ${f.email}` : '';
        const color = f.color || '#6c7ae0';
        const online= !!f.online;

        const row = document.createElement('label');
        row.className = 'invite-item';

        const cb  = document.createElement('input');
        cb.type   = 'checkbox';
        cb.value  = id;
        cb.className = 'invite-check';

        const ava = document.createElement('div');
        ava.className = 'invite-avatar';
        ava.style.background = color;
        ava.textContent = initial(nick);

        const meta = document.createElement('div');
        meta.className = 'invite-meta';
        const nameEl = document.createElement('div');
        nameEl.className = 'invite-name';
        nameEl.textContent = nick;
        const subEl = document.createElement('div');
        subEl.className = 'invite-sub';
        subEl.textContent = (email || '').replace(/^ Â· /,'');
        meta.append(nameEl, subEl);

        const st = document.createElement('span');
        st.className = 'invite-status';
        st.textContent = online ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';

        row.append(cb, ava, meta, st);
        listEl.appendChild(row);
      }

      // ê°œë³„ ì²´í¬ ë³€ê²½ ì‹œ ì „ì²´ì„ íƒ ìƒíƒœ ë™ê¸°í™”
      listEl.querySelectorAll('.invite-check').forEach(cb => {
        cb.addEventListener('change', syncSelectAllState);
      });
      syncSelectAllState();
    }

    /** ì„ íƒëœ ID */
    function selectedIds() {
      return Array.from(listEl.querySelectorAll('.invite-check:checked'))
                  .map(x => x.value).filter(Boolean);
    }

    /** ì „ì²´ì„ íƒ í† ê¸€ */
    selectAll.addEventListener('change', () => {
      listEl.querySelectorAll('.invite-check').forEach(c => c.checked = selectAll.checked);
    });

    /** ì „ì²´ì„ íƒ ì²´í¬ ë™ê¸°í™” */
    function syncSelectAllState() {
      const checks = listEl.querySelectorAll('.invite-check');
      const checked = listEl.querySelectorAll('.invite-check:checked');
      selectAll.checked = (checks.length > 0 && checks.length === checked.length);
      selectAll.indeterminate = (checked.length > 0 && checked.length < checks.length);
    }

    /** 3) ëª¨ë‹¬ ì—´ ë•Œ: â€œìˆ˜ë½ëœ ì¹œêµ¬ ëª©ë¡â€ ê¸°ë³¸ ì¶œë ¥ */
    async function openModal() {
      modal.hidden = false;
      searchInput.value = '';
      selectAll.checked = false;
      selectAll.indeterminate = false;

      listEl.innerHTML = `<div style="text-align:center;color:#777;padding:18px;">ë¡œë”© ì¤‘â€¦</div>`;
      try {
        const friends = await fetchAcceptedFriends();
        modal.dataset._cache = JSON.stringify(friends);
        renderList(friends); // â† ê¸°ë³¸ ì¶œë ¥
      } catch (e) {
        console.error(e);
        listEl.innerHTML = `<div style="text-align:center;color:#b00;padding:18px;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
      }
    }

    function closeModal() { modal.hidden = true; }

    /** ì´ë²¤íŠ¸ ë°”ì¸ë”© */
    inviteBtn.addEventListener('click', e => { e.preventDefault(); openModal(); });
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    backdrop.addEventListener('click', closeModal);
    document.addEventListener('keydown', e => { if (!modal.hidden && e.key === 'Escape') closeModal(); });

    // ê²€ìƒ‰ ì‹œ ìºì‹œì—ì„œ í•„í„°
    searchInput.addEventListener('input', () => {
      const cache = JSON.parse(modal.dataset._cache || '[]');
      renderList(cache, searchInput.value);
    });

    // ìƒˆë¡œê³ ì¹¨ ì‹œ ì„œë²„ ì¬ì¡°íšŒ
    reloadBtn.addEventListener('click', async () => {
      listEl.innerHTML = `<div style="text-align:center;color:#777;padding:18px;">ë¡œë”© ì¤‘â€¦</div>`;
      try {
        const friends = await fetchAcceptedFriends();
        modal.dataset._cache = JSON.stringify(friends);
        renderList(friends, searchInput.value);
      } catch (e) {
        console.error(e);
        alert('ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨');
      }
    });

    /** 4) ì´ˆëŒ€ ì „ì†¡: ì„ íƒëœ ì¹œêµ¬ë§Œ */
    sendBtn.addEventListener('click', async () => {
      const ids = selectedIds();
      if (ids.length === 0) {
        alert('ì´ˆëŒ€í•  ì¹œêµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      sendBtn.disabled = true;
      try {
        const { data, status } = await axios.post(`/room/${roomId}/invite`, { inviteeIds: ids });
        if (status === 200 || status === 201) {
          alert(data?.message || `ì´ˆëŒ€ ${ids.length}ëª…ì—ê²Œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          closeModal();
        } else {
          alert(data?.message || 'ì´ˆëŒ€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error(err);
        alert('ì´ˆëŒ€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        sendBtn.disabled = false;
      }
    });
  })();
</script>
<script>
  // â‘  ì•ˆì „í•œ escape
  function escapeHtml(s='') {
    return String(s).replace(/[&<>"'`=\/]/g, ch => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',
      '/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
    }[ch]));
  }

  // â‘¡ ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸(<mark>) â€“ ì•ˆì „í•˜ê²Œ
  function highlight(text, q) {
    if (!q) return escapeHtml(text);
    const escQ = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // regex escape
    return escapeHtml(text).replace(new RegExp(escQ, 'ig'), m => `<mark>${escapeHtml(m)}</mark>`);
  }

  // â‘¢ ì•„ì´ë””/ë‹‰ ê¸°ë°˜ ìƒ‰ìƒ ê²°ì •(ì¼ê´€ëœ ì•„ë°”íƒ€ ë°°ê²½)
  function hashColor(seed = 'user') {
    let h = 0;
    for (let i = 0; i < seed.length; i++) h = (h * 31 + seed.charCodeAt(i)) | 0;
    // íŒŒìŠ¤í…” í†¤ HSL
    const hue = Math.abs(h) % 360;
    return `hsl(${hue} 70% 55%)`;
  }

  // â‘£ ê¹”ë” ë Œë”ëŸ¬
  //  - ì„ íƒ ìœ ì§€
  //  - ì˜¨ë¼ì¸ ìš°ì„  ì •ë ¬, ê·¸ ë‹¤ìŒ createdAt desc(ìˆìœ¼ë©´)
  //  - ê²€ìƒ‰ í•˜ì´ë¼ì´íŠ¸
  function renderList(friends, keyword = '') {
    // í˜„ì¬ ì„ íƒ ìœ ì§€ìš©
    const prevSelected = new Set(
      Array.from(listEl.querySelectorAll('.invite-check:checked'))
           .map(x => x.value)
    );

    listEl.innerHTML = '';
    const q = keyword.trim().toLowerCase();

    // í•„í„°
    let rows = friends.filter(f => {
      const name  = String(f.nick || f.name || '');
      const email = String(f.email || '');
      return !q || name.toLowerCase().includes(q) || email.toLowerCase().includes(q);
    });

    // ì •ë ¬: ì˜¨ë¼ì¸ â†’ ì˜¤í”„ë¼ì¸, since(createdAt) ìµœì‹  â†’ ê³¼ê±°, ì´ë¦„ìˆœ ë³´ì¡°
    rows.sort((a, b) => {
      const ao = a.online ? 1 : 0, bo = b.online ? 1 : 0;
      if (ao !== bo) return bo - ao; // online first
      const at = new Date(a.since || a.createdAt || 0).getTime();
      const bt = new Date(b.since || b.createdAt || 0).getTime();
      if (at !== bt) return bt - at; // latest first
      const an = (a.nick || a.name || '').localeCompare(b.nick || b.name || '');
      return an;
    });

    // ë¹„ì—ˆì„ ë•Œ
    if (!rows.length) {
      listEl.innerHTML = `
        <div class="invite-empty">
          <span class="emoji">ğŸ«¥</span>
          í‘œì‹œí•  ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>`;
      syncSelectAllState();
      return;
    }

    const frag = document.createDocumentFragment();

    // ìƒë‹¨ ì¹´ìš´íŠ¸ í‘œì‹œ(ì„ íƒì‚¬í•­)
    const countInfo = document.createElement('div');
    countInfo.className = 'invite-count';
    const onlineCount = rows.filter(f => !!f.online).length;
    countInfo.textContent = `ì´ ${rows.length}ëª… Â· ì˜¨ë¼ì¸ ${onlineCount}ëª…`;
    frag.appendChild(countInfo);

    for (const f of rows) {
      const id     = String(f._id || f.id || '');
      const nick   = String(f.nick || f.name || 'ì¹œêµ¬');
      const email  = String(f.email || '');
      const online = !!f.online;

      // ì•„ë°”íƒ€ ì»¬ëŸ¬: ìš°ì„ ìˆœìœ„ color â†’ í•´ì‹œ ìƒ‰
      const color  = f.color || hashColor(id || nick);

      const row = document.createElement('label');
      row.className = 'invite-item';

      // ì²´í¬ë°•ìŠ¤(ì„ íƒ ìœ ì§€)
      const cb  = document.createElement('input');
      cb.type   = 'checkbox';
      cb.value  = id;
      cb.className = 'invite-check';
      cb.checked = prevSelected.has(id);

      const ava = document.createElement('div');
      ava.className = 'invite-avatar';
      ava.style.background = color;
      ava.textContent = (String(nick)[0] || 'U').toUpperCase();

      const meta = document.createElement('div');
      meta.className = 'invite-meta';
      const nameEl = document.createElement('div');
      nameEl.className = 'invite-name';
      nameEl.innerHTML = highlight(nick, q);

      const subEl = document.createElement('div');
      subEl.className = 'invite-sub';
      subEl.innerHTML = email ? highlight(email, q) : '&nbsp;';

      meta.append(nameEl, subEl);

      const st = document.createElement('span');
      st.className = 'invite-status' + (online ? '' : ' offline');
      st.textContent = online ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';

      row.append(cb, ava, meta, st);
      frag.appendChild(row);
    }

    listEl.appendChild(frag);

    // ì´ë²¤íŠ¸ & ì „ì²´ì„ íƒ ë™ê¸°í™”
    listEl.querySelectorAll('.invite-check').forEach(cb => {
      cb.addEventListener('change', syncSelectAllState);
    });
    syncSelectAllState();
  }
</script>

