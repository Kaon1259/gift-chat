<%- include('layouts/layout', { title: (typeof title !== 'undefined' ? title : 'GIF ì±„íŒ…ë°©') }) %>

<h1><%= title %></h1>
<a href="/" id="exit-btn">ë°© ë‚˜ê°€ê¸°</a>

<fieldset>
  <legend>ì±„íŒ… ë‚´ìš©</legend>
  <div id="chat-list">
    <% chats.forEach(function(chat) { %>
      <% 
        // ğŸš¨ ì£¼ì˜: EJS ì´ˆê¸° ë Œë”ë§ ì‹œ chat.userê°€ 'ìƒ‰ìƒì½”ë“œ'ê°€ ì•„ë‹Œ 'ë‹‰ë„¤ì„'ì´ë¼ë©´ userì™€ ë¹„êµí•´ì•¼ í•©ë‹ˆë‹¤.
        // í˜„ì¬ chat.userì— ìƒ‰ìƒ ì½”ë“œê°€ ì €ì¥ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
        const isMyChat = chat.user === user; 
      %>
      <div class="<%= isMyChat ? 'mine' : (chat.user === 'system' ? 'system' : 'other') %>">
        <% if (chat.user !== 'system') { %>
          <div style="color: '<%= chat.user %>'" class="socket-id-display" data-socket-id="<%= chat.socketId %>">
            <%= chat.user %>
            <% if (chat.socketId) { %>
                (<%= chat.socketId.substring(0, 4) %>...)
            <% } %>
          </div>
        <% } %>
        <% if (chat.gif) { %>
          <img src="/gif/<%= chat.gif %>">
        <% } else { %>
          <div><%= chat.chat %></div>
        <% } %>
      </div>
    <% }); %>
  </div>
</fieldset>

<form action="/chat" id="chat-form" method="post" enctype="multipart/form-data">
  <label for="gif">GIF ì˜¬ë¦¬ê¸°</label>
  <input type="file" id="gif" name="gif" accept="image/gif">
  <input type="text" id="chat" name="chat">
  <button type="submit">ì „ì†¡</button>
</form>

<form action="/broadcastchat" id="broadcastchat-form" method="post" enctype="multipart/form-data">
  <label>ì™¸ì¹˜ê¸°</label>
  <input type="text" id="broadcastchat-input" name="chat">
  <button type="submit">ì „ì†¡</button>
</form>

<form action="/whisperchat" id="whisperchat-form" method="post" style="display: none; margin-top: 10px; border: 1px solid #ccc; padding: 10px;">
  <legend>ê·“ì†ë§ ë³´ë‚´ê¸°</legend>
  <label for="whisper-target-display">ëŒ€ìƒ:</label>
  <input type="hidden" id="whisper-target-socketid" name="targetSocketId"> 
  <span id="whisper-target-display" style="font-weight: bold; margin-right: 10px;"></span>
  
  <input type="text" id="whisper-chat-input" name="chat" placeholder="ê·“ì†ë§ ë‚´ìš©">
  <button type="submit">ê·“ì†ë§ ì „ì†¡</button>
  <button type="button" id="whisper-cancel-btn">ì·¨ì†Œ</button>
</form>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  // ê°™ì€ ì˜¤ë¦¬ì§„ì´ë©´ í˜¸ìŠ¤íŠ¸/í¬íŠ¸ ìƒëµ ê¶Œì¥
  const socket = io('/chat', { path: '/socket.io' });

  // ì—°ê²° ì™„ë£Œ í›„ joinì„ ë³´ë‚´ëŠ” ê²Œ ì•ˆì „
  socket.on('connect', () => {
    const roomId = new URL(location).pathname.split('/').at(-1);
    socket.emit('join', roomId);
  });

  socket.on('join', function (data) {
    const div = document.createElement('div');
    div.classList.add('system');
    const chat = document.createElement('div');
    chat.textContent = data.chat;
    div.appendChild(chat);
    document.querySelector('#chat-list').appendChild(div);
  });

  socket.on('exit', function (data) {
    const div = document.createElement('div');
    div.classList.add('system');
    const chat = document.createElement('div');
    chat.textContent = data.chat;
    div.appendChild(chat);
    document.querySelector('#chat-list').appendChild(div);
  });


  socket.on('chat', function (data) {
    // data = { chat: {...}, socketId: '...' }
    const doc = data.chat || data; // í˜¹ì‹œ ì„œë²„ê°€ ë¬¸ì„œë§Œ ë³´ë‚¼ ê²½ìš° ëŒ€ë¹„

    const div = document.createElement('div');

    // ë‚´ ë©”ì‹œì§€ íŒë³„: socket.idì™€ payloadì˜ socketId ë¹„êµ(ì„ íƒ)
    const isMine = typeof socket !== 'undefined' && data.socketId && socket.id === data.socketId;
    div.classList.add(isMine ? 'mine' : 'other');

    const name = document.createElement('div');
    //name.textContent = doc.user; // â† ê¸°ì¡´ data.user â†’ doc.user
    name.textContent = `(${data.socketId})`; // âœ… socket.id í‘œì‹œ
    div.appendChild(name);

    if (doc.chat) {
      const chat = document.createElement('div');
      chat.textContent = doc.chat; // â† ê¸°ì¡´ data.chat â†’ doc.chat
      div.appendChild(chat);
    } else if (doc.gif) {
      const gif = document.createElement('img');
      gif.src = '/gif/' + doc.gif; // â† ê¸°ì¡´ data.gif â†’ doc.gif
      div.appendChild(gif);
    }

    // ìƒ‰ìƒ ì ìš©: user í•„ë“œê°€ 'ìƒ‰ìƒì½”ë“œ'ë¼ë©´ ê·¸ëŒ€ë¡œ, 'ìœ ì €ëª…'ì´ë¼ë©´ ë³„ë„ color í•„ë“œë¥¼ ì“°ì„¸ìš”.
    if (/^#|rgb|hsl/.test(doc.user)) {
      div.style.color = doc.user;     // userê°€ ìƒ‰ìƒì½”ë“œì¸ êµ¬ì¡°ë¼ë©´
    }
    if (doc.color) {
      div.style.color = doc.color;    // color í•„ë“œë¥¼ ë”°ë¡œ ì“´ë‹¤ë©´
    }

    document.querySelector('#chat-list').appendChild(div);
  });

  socket.on('broadcastchat', function (data) {
    const div = document.createElement('div');
    if (data.user === '<%= user %>') {
      div.classList.add('mine');
    } else {
      div.classList.add('other');
    }

    const name = document.createElement('div');
    name.textContent = data.user;
    div.appendChild(name);

    if (data.chat) {
      const chat = document.createElement('div');
      chat.textContent = data.chat;
      div.appendChild(chat);
    } else {
      const gif = document.createElement('img');
      gif.src = '/gif/' + data.gif;
      div.appendChild(gif);
    }

    // ëŸ°íƒ€ì„ì—ì„œë„ ìƒ‰ìƒ ì ìš© (ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¨ ì‹¤ì‚¬ìš©ì ìƒ‰ìƒ)
    if (data.user) div.style.color = data.user;

    document.querySelector('#chat-list').appendChild(div);
  });

  // â­ï¸ ê·“ì†ë§ í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  const chatList = document.querySelector('#chat-list');
  const whisperForm = document.querySelector('#whisperchat-form');
  const whisperCancelBtn = document.querySelector('#whisper-cancel-btn');
  const whisperTargetDisplay = document.querySelector('#whisper-target-display');
  const whisperTargetSocketId = document.querySelector('#whisper-target-socketid');
  const whisperChatInput = document.querySelector('#whisper-chat-input');


  // 1. ì†Œì¼“ ID í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (DOM ìœ„ì„)
  chatList.addEventListener('click', function(e) {
    if (e.target.classList.contains('socket-id-display')) {
      const targetId = e.target.dataset.socketId;

      if (!targetId || targetId === socket.id) {
          alert(targetId ? "ìê¸° ìì‹ ì—ê²ŒëŠ” ê·“ì†ë§ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." : "ìœ íš¨í•œ ì†Œì¼“ IDê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
      }

      // í¼ì„ ë³´ì´ê²Œ í•˜ê³  ëŒ€ìƒ ID ì„¤ì •
      whisperTargetSocketId.value = targetId;
      whisperTargetDisplay.textContent = targetId;
      whisperForm.style.display = 'block';

      whisperChatInput.focus();
    }
  });

  // 2. ê·“ì†ë§ ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸
  whisperCancelBtn.addEventListener('click', function() {
    whisperForm.style.display = 'none';
    whisperTargetSocketId.value = '';
    whisperChatInput.value = '';
  });


  // 3. ê·“ì†ë§ í¼ ì œì¶œ ì´ë²¤íŠ¸
  whisperForm.addEventListener('submit', function (e) {
    e.preventDefault();
    const targetId = whisperTargetSocketId.value;
    const chatValue = whisperChatInput.value;

    if (targetId && chatValue) {
      // ê·“ì†ë§ ì „ì†¡ì„ ìœ„í•œ POST ìš”ì²­ (ì„œë²„ ë¼ìš°íŠ¸ í•„ìš”)
      axios.post('/room/<%= room._id %>/whisperchat', {
          targetSocketId: targetId,
          chat: chatValue,
      })
      .then(() => { 
          // ì„±ê³µ í›„ ë‚˜ì—ê²Œë„ ê·“ì†ë§ ë³´ëƒ„ (ì „ì†¡ í™•ì¸ìš©)
          socket.emit('whisper', { fromUser: 'ë‚˜', chat: chatValue });
          
          whisperChatInput.value = ''; 
          whisperForm.style.display = 'none'; // í¼ ìˆ¨ê¸°ê¸°
      })
      .catch((err) => { console.error(err); });
    }
  });


  document.querySelector('#chat-form').addEventListener('submit', function (e) {
    e.preventDefault();
    if (e.target.chat.value) {
      axios.post('/room/<%= room._id %>/chat', {
        chat: this.chat.value,
      })
      .then(() => { e.target.chat.value = ''; })
      .catch((err) => { console.error(err); });
    }
  });

  document.querySelector('#broadcastchat-form').addEventListener('submit', function (e) {
    e.preventDefault();
    if (e.target.chat.value) {
      axios.post('/room/<%= room._id %>/broadcastchat', {
        chat: this.chat.value,
      })
      .then(() => { e.target.chat.value = ''; })
      .catch((err) => { console.error(err); });
    }
  });

  document.querySelector('#gif').addEventListener('change', function (e) {
    const formData = new FormData();

    if (e.target.files && e.target.files[0]) {
      formData.append('gif', e.target.files[0]);
      axios.post('/room/<%= room._id %>/gif', formData)
        .then(() => { e.target.value = null; })
        .catch((err) => { console.error(err); });
    }
  });
</script>
